<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>{{ tournament.name }} | Brickado Hub</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
</head>
<body class="bg-light">
<div class="container py-4">

    <!-- Cabeçalho -->
    <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
            <h1 class="h4 mb-1">{{ tournament.name }}</h1>
            <p class="mb-1">
                {{ tournament.get_game_display }} •
                {{ tournament.date|date:"d/m/Y" }}
                {% if tournament.location %} • {{ tournament.location }}{% endif %}
            </p>
            <p class="mb-1 text-muted">
                Origem: {{ tournament.get_source_display }} •
                Formato: {{ tournament.get_format_display }} •
                {% if tournament.is_ranked %}
                    Conta para ranking
                {% else %}
                    Não conta para ranking
                {% endif %}
            </p>
            <p class="mb-1">
                <strong>Status:</strong>
                {% if tournament.status == "REG" %}
                    Inscrições
                {% elif tournament.status == "RUN" %}
                    Em andamento
                {% elif tournament.status == "DONE" %}
                    Encerrado
                {% endif %}
                • Rodada {{ tournament.current_round }} de {{ tournament.total_rounds }}
            </p>
            <p class="text-muted mb-0 small">
                Pontuação: vitória = {{ tournament.win_points }}
                | empate = {{ tournament.draw_points }}
                | derrota = {{ tournament.loss_points }}
            </p>
        </div>

        <a href="{% url 'tournaments_home' %}" class="btn btn-outline-secondary btn-sm">
            ← Voltar para torneios
        </a>
    </div>

    <!-- Desempates -->
    <div class="mb-3">
        <p class="fw-semibold mb-1">Desempates padrão (estilo Bandai):</p>
        <ol class="small mb-0">
            <li>Match Points (total de pontos)</li>
            <li>OMW% (Opponents' Match Win Rate): média da taxa de vitórias dos seus oponentes.</li>
            <li>OOMW% (Opponents' Opponents' Match Win Rate): média da taxa de vitórias dos oponentes dos seus oponentes.</li>
        </ol>
    </div>

    {% if tournament.notes %}
        <div class="alert alert-info py-2">
            {{ tournament.notes }}
        </div>
    {% endif %}

    <!-- Minha participação / Acesso ao painel -->
    <div class="card mb-4">
        <div class="card-body">
            <h2 class="h6 mb-2">Minha participação</h2>

            {% if user.is_staff %}
                <p class="small text-muted mb-2">
                    Você é staff, use o painel abaixo para controlar o torneio.
                </p>
                <a href="{% url 'tournament_admin_panel' pk=tournament.id %}"
                   class="btn btn-outline-dark btn-sm">
                    Abrir painel do organizador
                </a>
            {% else %}
                {% if tournament.status == "REG" and tournament.allow_self_registration and not tournament.registration_closed %}
                    <p class="small mb-2">
                        Inscrições abertas! Você pode se registrar para este torneio pelo app.
                    </p>
                    <a href="{% url 'tournament_register' pk=tournament.id %}"
                       class="btn btn-primary btn-sm">
                        Fazer minha inscrição
                    </a>
                {% else %}
                    <p class="small mb-2 text-muted">
                        Inscrições encerradas ou não disponíveis pelo app.
                    </p>
                {% endif %}

                {% if tournament.status == "RUN" %}
                    <a href="{% url 'tournament_my_match' pk=tournament.id %}"
                       class="btn btn-outline-primary btn-sm ms-0 mt-2">
                        Ver minha partida desta rodada
                    </a>
                {% endif %}
            {% endif %}
        </div>
    </div>

    <!-- CLASSIFICAÇÃO -->
    <h2 class="h5 mb-2">Classificação</h2>

    {# filtra "na unha": se realmente não tiver nenhum resultado/jogador, mostra mensagem #}
    {% if standings %}
        <div class="table-responsive">
            <table class="table table-sm table-striped align-middle">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Jogador</th>
                        <th>Deck / Arquétipo</th>
                        <th>Vit</th>
                        <th>Emp</th>
                        <th>Der</th>
                        <th>Pontos</th>
                        <th class="text-center">OMW%</th>
                        <th class="text-center">OOMW%</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in standings %}
                        <tr>
                            <td>
                                {% if r.final_rank %}
                                    {{ r.final_rank }}
                                {% else %}
                                    {{ forloop.counter }}
                                {% endif %}
                            </td>
                            <td>
                                {{ r.player_name }}
                                {% if r.bandai_id %}
                                    <br><small class="text-muted">ID: {{ r.bandai_id }}</small>
                                {% endif %}
                            </td>
                            <td>
                                {% if r.deck_archetype_name %}
                                    {{ r.deck_archetype_name }}
                                {% elif r.deck %}
                                    {{ r.deck.nome }}
                                {% else %}
                                    <span class="text-muted">Não informado</span>
                                {% endif %}
                            </td>
                            <td>{{ r.wins }}</td>
                            <td>{{ r.draws }}</td>
                            <td>{{ r.losses }}</td>
                            <td><strong>{{ r.match_points }}</strong></td>
                            <td class="text-center">
                                {% if r.omw is not None %}
                                    {{ r.omw|floatformat:2 }}%
                                {% else %}
                                    <span class="text-muted">–</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if r.oomw is not None %}
                                    {{ r.oomw|floatformat:2 }}%
                                {% else %}
                                    <span class="text-muted">–</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if tournament.status != "DONE" %}
            <p class="text-muted small mt-1">
                Classificação parcial. A ordem final será confirmada quando o torneio for encerrado
                pelo organizador.
            </p>
        {% else %}
            <p class="text-muted small mt-1">
                Classificação final do torneio, já considerando os critérios de desempate.
            </p>
        {% endif %}

    {% else %}
        <p class="text-muted">
            Nenhum jogador inscrito ou nenhum resultado lançado ainda para este torneio.
            Use o painel de <strong>Admin</strong> para incluir os jogadores e resultados.
        </p>
    {% endif %}

</div>
</body>
</html>
